## El Kernel 
![[Pasted image 20240103114200.png]]

▪ Executive Services: independent kernel components to provide a service.

▪ Object Manager: handles files, threads, processes, events, semaphores, mutexes, access tokens, etc.

▪ Kernel Mode Drivers: provide hardware compatibility, such as printers, external storage, etc.

▪ Microkernel: handles interruptions, service/driver initialization, scheduling.



### Separation user and kernel mode
![[Pasted image 20240103114530.png]]

- every process passes, that interacts in user mode and needs kernel access(e. g. system calls) passes by the NTDLL.DLL file 
 ![[Pasted image 20240103114802.png]]
- this allows to intercept every system call -> API Hooking


#### API Hooking and bypassing
- just as it is possible to install hooks in the API, user code could attempt to detect and remove them
- understanding how kernel calls work and implementing them ourselves: direct syscalls → SysWhispers (1, 2, 3…).
![[Screenshot from 2024-01-03 11-51-23.png]]
- The act of bypassing hooks could be detectable in itself



# Windows processes
![[Pasted image 20240103115422.png]]
- **Thread:** Executes a set of instructions, has an identifier, and an execution context. Managed by Windows. Utilizes the resources of the process.

- **Fiber:** Similar to a thread but managed by the process. Lightweight and does not involve the kernel.

- **Process:** An instance of a program. Associated with an ID, a private virtual address space, executable code, a security context, a list of handles, and at least one thread.

- **Job:** A group of processes grouped together to manage them as a unit. Its usage is optional.


### Context switches and CPU usage
- If there are more CPUs than threads, the decision is trivial as all can execute in parallel.
- if not: **Task Scheduler:** Decides what runs at each moment based on available resources. In Windows, it schedules the execution of threads, not processes.
		▪ **Preemptive:** It is possible to interrupt the execution of a thread without its cooperation. The execution can be paused to resume it later.
		▪ **Context Switch:** Involves saving and cleaning up the current state of the CPU and restoring the state of the thread to be resumed.

#### Handles in Windows
**Handles:** References to resources or kernel objects, returned to user code so it can reference them in future calls.

Examples include files, processes, mutexes, semaphores, threads, timers, and windows. More details can be found at [Microsoft's Object Categories](https://learn.microsoft.com/en-us/windows/win32/sysinfo/object-categories).

The object or resource is owned by the kernel, which is responsible for creating and destroying it.
![[Pasted image 20240103115804.png]]


## Windows management tools
LGPE (Local Group Policy Editor) is part of the administrative tools in Windows. Other examples include:

▪ **Task Scheduler:** Used to view and edit scheduled tasks.

▪ **Registry Editor:** Allows viewing and editing the Windows Registry.

▪ **Event Viewer:** Used to view and edit events generated by applications or the operating system itself.

▪ **Resource Monitor:** Similar to the Task Manager, it provides much more detailed information about resource usage.


## Windows administrative tools--sysinternals
- **Sysmon (System Monitor):** Generates events every time a file is executed, a network connection is opened, etc. Useful for monitoring anomalous activities.
    
- **Procexp (Process Explorer):** Allows easy extraction of a wealth of information about all running processes. Similar to the Resource Monitor.
    
- **Procmon (Process Monitor):** Monitors the activity of a process, especially file access, registry, and network activity.
https://lolbas-project.github.io


[[Access Control]]
